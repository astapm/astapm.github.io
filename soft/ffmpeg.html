<!DOCTYPE html>
<html lang="ru">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all" />
<meta name="date" content='15-03-2017'>
<meta name="description" content="FFmpeg — набор библиотек и утилит командной строки, позволяющих производить практически все основные операции редактирования и преобразования файлов видео и звуковых файлов. Ниже шпаргалка из основных команд для работы с FFmpeg, которые могут пригодиться при редактировании видео. Особенно обратим внимание на не-деструктивное без потери качества редактирование файлов видео и звуковых файлов. Лицензия: GNU LGPL и GNU GPL." />
<meta name="keywords" content="FFmpeg, редактирование видео, командная строка" />
<meta name="author" content="Михаил Астапчик" />
<meta name="copyright" content="CC0 1.0 Универсальная" />
<link rel="stylesheet" href="../style.css" type="text/css"/>
<link rel="alternate" type="application/rss+xml" title="Моя RSS-лента" href="https://astapm.github.io/rss.xml" />
<link rel="license" href="https://creativecommons.org/publicdomain/zero/1.0" />
<link rel="canonical" href="https://astapm.github.io/soft/ffmpeg.html" />
<title>
FFmpeg как консольный видео-редактор — Домашняя страница. М. Астапчик 
</title>
</head>
<body>
<header>
<p><a href="../index.html"><strong>Главная</strong></a> | <a href="index.html"><strong>Оглавление книги</strong></a></p>
</header>
<article>
<h1 id="ffmpeg-как-консольный-видео-редактор">FFmpeg как консольный видео-редактор</h1>
<hr />
<p><em>FFmpeg — набор библиотек и утилит командной строки, позволяющих производить практически все основные операции редактирования и преобразования файлов видео и звуковых файлов. Ниже шпаргалка из основных команд для работы с FFmpeg, которые могут пригодиться при редактировании видео. Особенно обратим внимание на не-деструктивное без потери качества редактирование файлов видео и звуковых файлов. Лицензия: GNU LGPL и GNU GPL. Сайт: <a href="http://ffmpeg.org/download.html">http://ffmpeg.org</a></em></p>
<hr />
<h2 id="ffmpeg-для-начинающих">FFmpeg для начинающих</h2>
<p>Съёмка видеороликов в цифровых форматах с помощью смартфонов, фотоаппаратов и прочих цифровых приспособлений стала распространённым явлением. Само собой возникает необходимость как-то редактировать снятые видеоролики, — например, для размещения на «Ютубе». То есть видеоролики часто нужно обрезать, заменять или удалять звуковую дорожку, изменить размер формат видео, а потом всё склеивать в единый файл видео.</p>
<p>Для этого массового занятия создаётся немало программ. Взять хотя бы поставлявшийся ранее в системы Windows видео редактор MoveMaker. Мы же рассмотрим набор утилит и библиотек для редактирования и преобразования медиафайлов под названием FFmpeg.</p>
<h3 id="чем-хорош-ffmpeg">Чем хорош FFmpeg:</h3>
<ul>
<li><p>Файлы FFmpeg доступны по общественной лицензии. То есть исходный код свободно открыт для изучения, модификации и распространения. И сами программы практически бесплатны, как книги в общественной библиотеки.</p></li>
<li><p>Как и характерно для общественных программ, FFmpeg распространяется для всех популярных операционных системах — GNU/Linux, Windows, MacOS.</p></li>
<li><p>Программы FFmpeg являются консольными, редактировать файлы мультимедиа можно прямо из командной строки. Что делает утилиты FFmpeg незаменимыми для автоматизации обработки файлов видео и звуковых файлов в различного рода скриптах и сценариях — например, на веб-сайтах.</p></li>
<li><p>FFmpeg имеет собственную библиотеку с поддержкой большого количества кодеков для различных форматов мультимедийных файлов — практически на все случаи жизни. Плюс можно собирать FFmpeg с возможностью подключения сторонних кодеков.</p></li>
<li><p>Соответственно для консольных утилит можно создавать и программные оболочки, похожие, например, на MoveMaker, где операции делаются не через командную строку, а с помощью графического интерфейса и манипулятора «мышь». В силу общественной лицензии чего компоненты FFmpeg можно найти практических в большинстве программ для перекодирования и редактирования видео.</p></li>
<li><p>FFmpeg для работы позволяет редактировать многие видеоролики без потери качества. У обычного потребителя возможности снимать несжатое или lossless-видео обычно нет, ролики уже получаются сжатыми и дальнейшее редактирование с перекодированием ещё больше добавит артефактов на видео-изображение. Поэтому возможность не-деструктивного без пережатия редактирования видео-файлов никому не помешает.</p></li>
</ul>
<p>Так же следует отметить, что FFmpeg имеет альтернативу — форк <a href="http://libav.org/">Libav</a>. Синтаксис параметров команд одинаков в обоих случаях.</p>
<h2 id="о-форматах-и-кодеках">О форматах и кодеках</h2>
<p>Коротко нужно сказать в качестве не лирического отступления о форматах файлов видео и звуковых файлов. Понимание этого нужно для того, чтобы команды этого набора утилит и библиотек не выглядели как магические заклинания.</p>
<p>Обычно файл видео представляет собой контейнер. Это что-то наподобие архива, созданного архиватором zip или tar, в котором содержаться множество файлов. По сути, в таком контейнере имеются файлы видео-данных, одна или несколько звуковых дорожек, могут быть текстовые файлы субтитров, могут быть и ещё какие-нибудь данные. Обычно эти входящие в контейнер файлы называются потоками.</p>
<p>Распространёнными форматами контейнеров для видео являются 3gp, MP4, MOV, MPEG, AVI, MKV ("Матрёшка"), WEBM и др. FFmpeg работает с большим количеством таких форматов контейнеров.</p>
<p>Формат звуковых файлов — MP3, OGG Vorbis, WAV и др. — обычно содержит аудио-трек и текстовые метаданные о жанре, авторе, исполнителе и т.п.</p>
<p>Непосредственно видео-данные в контейнерах «упакованы» в виде различных форматов, которые определяются кодеками — программами для кодирования и декодирования видео. Наиболее популярными кодеками являются кодеки H.264 и H.265 для контейнера MP4, V8 и V9 для контейнера WEBM.</p>
<p>FFmpeg работает с большим количеством кодеков, включая экзотические. Узнать список возможных кодеков в FFmpeg можно запустив команду ffmpeg с параметром <code>-codecs</code>.</p>
<pre><code>ffmpeg -codecs </code></pre>
<p>Основными параметрами видео-данных являются:</p>
<ul>
<li>разрешение изображения видео — например, 320х240, p720 и т.д;</li>
<li>формат и кодек, с помощью которого создавался видео-поток;</li>
<li>битрейт — количество данных в килобайтах или мегабайтах, которые нужно для проигрывания видео за одну секунду — например, 240 Kb/s, 1Mb/s;</li>
<li>фремрейт — количество кадров в секунду (frame per second) — например 24 fps, 30 fps.</li>
</ul>
<p>Для аудио-данных важными параметрами являются:</p>
<ul>
<li>формат и кодек, с помощью которого создавался звуковой поток;</li>
<li>частота дискретизации — например, 44 KHz;</li>
<li>битрейт — количество данных в килобайтах, которые нужно для проигрывания аудиофайла за одну секунду — например, 96 Kb/s, 128Mb/s;</li>
<li>режим моно, стерео и т.д.</li>
</ul>
<p>Но параметров на самом деле больше. Узнать параметры контейнера видео и входящих в него данных видео и аудио легко сделать с помощью команды fmpeg с параметром -i, которому передаётся путь и имя мультимедийного файла</p>
<pre><code>ffmpeg -i video.mp4</code></pre>
<figure>
<img src="../fig/soft/fig1.png" alt="" /><figcaption>Рис 1. Вывод FFmpeg информации о данных файла</figcaption>
</figure>
<h2 id="vidcutter-графический-интерфейс-для-ffmpeg">VidCutter: графический интерфейс для FFmpeg</h2>
<p>Но начать использование FFmpeg можно не только из командной строки. К FFmpeg существуют и графические оболочки – программы, в которых основные команды и операции можно производить с помощью графического интерфейса и манипулятора «мышь».</p>
<p>Примером такой очень простой графической оболочки является очень простенькая программа VidCutter. Она позволяет в графическом интерфейсе задействовать производить обрезку видео-файлов без перекодирования, то есть без потери качества.</p>
<figure>
<img src="../fig/soft/fig2.jpg" alt="" /><figcaption>Рис 2. VidCutter</figcaption>
</figure>
<p>Работа в этой программе состоит из одной операции — выделить начало и конец фрагмента и нажать кнопку обрезки видео. Но в большинстве случаев нужно больше, чем просто обрезать видео-файлы.</p>
<h2 id="установка-комплекта-утилит-ffmpeg">Установка комплекта утилит FFmpeg</h2>
<p><em>Linux.</em> Утилиты FFmpeg обычно входят во все репозитории дистрибутивов Linux и легко устанавливаются штатными менеджерами пакетов этих дистрибутивов. Также можно скачать с официального сайта готовые бинарные сборки ffmpeg и запускать их прямо из домашней папки. Или же собрать из исходников.</p>
<p>Для <em>Windows</em> и <em>Mac OS</em> можно скачать с официального сайта архив с готовые бинарными сборками FFmpeg, распаковать их в любой каталог. Нужные утилиты обычно находятся в папке bin. Запускать их нужно из командной строки, задавая путь к этим утилитам, непосредственно в командной строке или через добавление пути к утилитам через глобальные системные переменные.</p>
<p>Основных утилит в наборе FFmpeg две:</p>
<ul>
<li>ffmpeg — утилита для всех операций с файлами мультимедиа;</li>
<li>ffplay — очень простой проигрыватель для файлов мультимедиа, вместо которого можно использовать любой другой проигрыватель.</li>
</ul>
<h2 id="редактируем-c-ffmpeg">Редактируем c FFmpeg</h2>
<p>Допустим, у нас есть несколько дорогих нам файлов видео, сделанные когда-то каким-нибудь старым «Кэноном», или «Никоном», или камкордером. Нам хотелось обрезать лишнее в этих видео, убрать из них фоновый звук и наложить какую-нибудь музычку. Потом всё склеить в единый файл без перекодирования и потери качества.</p>
<p>Положим эти файлы в отдельную папочку и заходим в эту папку из командной строки для редактирования файлов видео с помощью команд ffmpeg.</p>
<p>Так же нужно держать правильный порядок и группировку параметров командной строки утилиты ffmpeg:</p>
<ul>
<li>Не забываем, что входной файл(ы) для манипуляций и редактирования задаётся сразу после команды <code>ffmpeg</code> после опции <code>-i</code>: <code>ffmpeg -i video.mp4</code>;</li>
<li>после параметров входного или входных файлов идут глобальные параметры — например, опция выбора потоков, опция нового разрешения видеоролика;</li>
<li>потом идёт опция видео-кодека, за которым перечисляются его параметры в том числе и видео-фильтры;</li>
<li>потом идёт опция аудио-кодека и перечисляются его параметры в том числе и фильтры;</li>
<li>завершает команду имя файла на выходе.</li>
</ul>
<p>Пример строки команды</p>
<pre><code>ffmpeg -i video.mpg -s 320x240 -vcodec -b 200K -acodec -ab 96K out.avi</code></pre>
<h3 id="ffmpeg-перекодирование-и-деструктивное-редактирование">FFmpeg: перекодирование и деструктивное редактирование</h3>
<p>Для многих операций редактирования файлов видео,— например для склейки видео, — эти файлы нужно привести к единому формату.</p>
<p>Основное предназначение FFmpeg — это перекодирование файлов мультимедиа из одного формата в другой. И перекодирование в FFmpeg может делаться очень легко.</p>
<p>Как самый минимум для перекодирования в другой формат нужно задать в выходном файле нужное расширение файла. И всё. По этому расширению утилита подберёт нужный кодек и перекодирует входной файл согласно параметрам по умолчанию для этого кодека, исходя из параметров входного файла. Например, следующая команда перекодирует входной файл формата MP4 <code>video.mp4</code> в файл контейнера WEBM <code>video.webm</code></p>
<pre><code>fmpeg -i video.mp4 video.webm</code></pre>
<p>Но параметры по умолчанию обычно являются базовыми и могут не обеспечить как желаемое качество или возможность дальнейшего редактирования. Поэтому параметры формата можно задавать явно. Перечислим основные опции для блока параметров видео и блока звука.</p>
<p>Опции ffmpeg для параметров видео:</p>
<ul>
<li><code>-vcodec</code> или кратко <code>c:v</code> — параметры видео-кодека, или "copy", или пустой параметр (значением по умолчанию)</li>
<li><code>-f</code> — формат контейнера</li>
<li><code>-b</code> — битрейт в килобитах или мегабитах в секунду задаётся буквой K или M</li>
<li><code>-aspect</code> — соотношение сторон картинки (4:3, 16:9, 1.3333, 1.7777)</li>
<li><code>-r</code> — фреймрейт</li>
</ul>
<p>Опции ffmpeg для параметров звука:</p>
<ul>
<li><code>-acodec</code> или кратко <code>c:a</code> — параметры кодека звука, или "copy", или пустой параметр (значением по умолчанию)</li>
<li><code>-f</code> — формат аудио</li>
<li><code>-ab</code> — битрейт аудио</li>
<li><code>-ar</code> — частота дискредитации</li>
<li><code>-ac</code> — количество каналов</li>
</ul>
<p>Например, перекодируем входной файл формата MP4 <code>video.mp4</code> в файл контейнера WEBM <code>video.webm</code> с некоторыми явно заданными параметрами</p>
<pre><code>ffmpeg -i video.mp4 -s 640x480 -vcodec -b 600kb/s -acodec -ab 128kb/s video.avi</code></pre>
<p>В результате этой команды запустится процесс перекодирования потоков видео и аудио с помощью выбранных кодеков согласно новым параметрам. В зависимости от параметров файлов мультимедиа и мощности компьютера этот процесс перекодирования может быть довольно длительный по времени.</p>
<h4 id="ffmpeg-изменение-разрешения-видео">FFmpeg: изменение разрешения видео</h4>
<p>Перекодирование будет произведено, естественно, и если просто задать новое разрешение для видео с помощью глобальной опции <code>-s</code></p>
<pre><code>ffmpeg -i video.mp4 -s 320х240 video.webm</code></pre>
<h3 id="ffmpeg-перекодирование-и-не-деструктивное-редактирование-видео-без-потери-качества">FFmpeg: перекодирование и не-деструктивное редактирование видео без потери качества</h3>
<p>Теперь о преобразование видео из одного формата в другой без потери качества. Для некоторых операций возможно редактирование без перекодирования звука и видео, без потери качества, когда потоки внутри файла контейнера остаются нетронутыми и просто копируются как есть из одного файла в другой. Для этого для опций <code>-vcodec</code> и <code>-acodec</code> используется параметр <code>copy</code>. Например «перельём» видео-поток и аудио-поток из файла формата MP4 <code>video.mp4</code> в файл контейнера TS <code>video.ts</code>:</p>
<pre><code>ffmpeg -i video.mp4 -vcodec copy -acodec copy video.ts</code></pre>
<p>В результате новый файл контейнер video.ts будет содержать нетронутое перекодированием видео и звук из файла контейнера video.ts.</p>
<h3 id="ffmpeg-не-деструктивная-нарезка-и-обрезка-файлов-видео">FFmpeg: не-деструктивная нарезка и обрезка файлов видео</h3>
<p>Обрезка видео файла производится при помощи опций <code>-ss</code> и <code>-t</code>. Опция <code>-ss</code> задаёт начало обрезки, а опция <code>-t</code> задаёт продолжительность дальнейшего фрагмента. Время задаётся в формате "часы:минуты:секунды". Для не-деструктивного редактирования содержимого видео-файла используйте параметр <code>copy</code>.</p>
<pre><code>ffmpeg -i video.mp4 -ss 00:00:02 -t 00:00:12 -vcodec copy -acodec copy video.mp4</code></pre>
<p>Обрезка без перекодирования происходит очень быстро и не отнимает много компьютерной мощности.</p>
<h3 id="ffmpeg-склейка-и-соединение-файлов-видео">FFmpeg: склейка и соединение файлов видео</h3>
<p>Что бы склеить, соединить видео-файлы с помощью ffmpeg, они должны быть одного формата, в том числе одинаковыми и по параметрам потоков видео и звука этого формата. Если это не так, то нужно произвести предварительное перекодирование файлов видео к единому формату.</p>
<p>Для многих форматов соединение файлов в ffmpeg происходит при помощи оператора <code>concat</code>, которому после двоеточия передаётся последовательность входных файлов, разделённых символом вертикальной черты. Пример склейки одинаковых и однотипных по формату файлов file1.avi и file2.avi без перекодирования:</p>
<pre><code>ffmpeg -i &quot;concat:file1.avi|file2.avi&quot; -vcodec copy -acodec copy output.avi</code></pre>
<p>Следует учитывать при соединении фрагментов видео в единый файл, что видео потоки и аудио потоки фрагментов складываются по отдельности, а потом объединяются в один контейнер. Поэтому если в одном из фрагментов звуковая дорожка короче по времени чем видео-поток, то звуковые дорожки остальных фрагментов сдвинутся к концу этой короткой звуковой дорожки и произойдёт рассинхронизация звука. Это надо учитывать.</p>
<h4 id="ffmpeg-склейка-и-соединение-файлов-формата-видео-mp4">FFmpeg: склейка и соединение файлов формата видео MP4</h4>
<p>Видео-файлы в контейнере MP4 нельзя соединить с помощью оператора <code>concat</code>. Но можно предварительно преобразовать эти файлы в контейнер, например, MPEG-TS без перекодирования видео и звука:</p>
<pre><code>ffmpeg -i vid1.mp4 -acodec copy -vcodec copy -vbsf h264_mp4toannexb -f mpegts vid1.ts
ffmpeg -i vid2.mp4 -acodec copy -vcodec copy -vbsf h264_mp4toannexb -f mpegts vid2.ts</code></pre>
<p>А потом эти файлы уже можно соединить при помощи оператора <code>concat</code> в итоговый файл mp4:</p>
<pre><code>ffmpeg -i &quot;concat:vid1.ts|vid2.ts&quot; -vcodec copy -acodec copy out.mp4</code></pre>
<h3 id="ffmpeg-удаление-звуковой-дорожки">FFmpeg: удаление звуковой дорожки</h3>
<p>Часто из видео-файла нужно удалить звуковой поток, чтобы потом заменить на какой-нибудь другой. Делается это с помощью опции <code>-an</code> (audio not).</p>
<pre><code>ffmpeg -i zvuk.mpg -vcodec copy -an bezzvuka.mpg</code></pre>
<h3 id="ffmpeg-добавление-или-замена-звуковой-дорожки">FFmpeg: добавление или замена звуковой дорожки</h3>
<p>Добавить звуковой поток в файл видео нужно с помощью дополнительной опции <code>-i</code> которой в качестве параметра передаётся путь звуковому файлу.</p>
<pre><code>ffmpeg -i bezzvuka.mpg -i zvuk.mp3 -vcodec copy -acodec copy zvuk.mpg</code></pre>
<h3 id="ffmpeg-опция--map-для-обращения-к-потокам-в-видео-фвйлах">FFmpeg: опция «-map» для обращения к потокам в видео-фвйлах</h3>
<p>Выше мы увидели пример многократного использования для ffmpeg опции <code>-i</code>, если обрабатываются, соединяются, мультиплексируются несколько входных файлов мультимедиа. Также выше было сказано, что файлы-контейнеры могут содержать в себе несколько мультимедийных потоков видео, звука и данных. FFmpeg имеет специальную опцию <code>-map</code>, с помощью которой можно указать конкретный входной мультимедийный поток или внутренний поток в контейнере для обработки, копирования или вставки.</p>
<p>Потоки обозначаются двойным номером, разделённых двоеточием — «0:0», «0:1», «1:0», «2:1» и т.д. Первая цифра до двоеточия — это номер по порядку каждого входного файла, задаваемого опцией <code>-i</code>, начиная с нуля. А номер после двоеточия обозначает номер потока внутри файла.</p>
<p>Рассмотрим опцию <code>-map</code> на конкретных примерах</p>
<h4 id="сохранить-отдельную-звуковую-дорожку-из-видео-файла-демультиплексация">Сохранить отдельную звуковую дорожку из видео-файла (демультиплексация)</h4>
<p>Номера потоков в каждом видео-файле можно определить через вывод команды <code>ffmpeg -i</code>, который будет иметь приблизительно такой формат:</p>
<pre><code>ffmpeg -i video.mkv
...
Stream #0:0(und): Video ...
Stream #0:1(ger): Audio ...
Stream #0:2(eng): Audio ...
Stream #0:3(rus): Subtitle …</code></pre>
<figure>
<img src="../fig/soft/fig3.png" alt="" /><figcaption>Рис 2. Вывод ffmpeg информации о потоках»</figcaption>
</figure>
<p>То есть 0 перед двоеточием означает, что это первый по порядку входной файл для ffmpeg — в примере выше это файл video.mkv. А номера после двоеточия означают номера внутренних потока этого файла. Для обработки конкретного потока опции <code>-map</code> нужно передать конкретный номер этого потока. Пример команды с опцией <code>-map</code>, которая демультиплексирует, то есть сохраняет одну из звуковых дорожек контейнера в отдельный файл:</p>
<pre><code>ffmpeg -i video.mkv -map 0:2 sound.wav</code></pre>
<h4 id="ffmpeg-добавить-несколько-звуковых-дорожек-в-видеофайл-мультиплексация">FFmpeg: добавить несколько звуковых дорожек в видеофайл (мультиплексация)</h4>
<p>Теперь рассмотрим пример добавления нескольких звуковых дорожек в видео-файл с помощью FFmpeg. Для этого опять используем опцию <code>-map</code>.</p>
<p>Допустим у нас есть чистый видео-файл video.avi и мы подобрали к нему несколько звуковых дорожек zvuk1.mp3 и zvuk2.mp3 — например разная музыка или комментарии на разных языках. Теперь используем опцию '-map' для мультиплексации, то есть соединения этих файлов в единый файл контейнер:</p>
<pre><code>ffmpeg -i video.avi -i zvuk1.mp3 -i zvuk2.mp3 -map 0:0 -map 1:0 -map 2:0 out.avi</code></pre>
<p>Как видите, для входных файлов после опций <code>-i</code> в опциях <code>-map</code> используются номера перед двоеточием. И мы получили выходной видео-файл с двумя звуковыми дорожками внутри, между которыми можно переключаться во многих плеерах — например, в плеере mpv переключение между звуковыми дорожками делается через "#" (Shift+2).</p>
<p>Естественно можно было добавить параметры кодирования для нового видео-файла. Например опции <code>-c:v copy -c:a copy</code> позволили бы в примере выше сложить новый файл out.avi чистым копированием без перекодирования входных файлов video.avi, zvuk1.mp3 и zvuk2.mp3.</p>
<p>Таким образом с помощью FFmpeg можно добавить в видео-файл субтитры. Главное не запутаться в номерах входных потоков и потоков внутри контейнера.</p>
<h2 id="всегда-под-рукой">Всегда под рукой</h2>
<p>Выше в статье рассказано в стиле шпаргалки про основные команды FFmpeg для начинающих. За рамками статьи оказалось много синтаксических возможностей командной строки ffmpeg, так и — много функциональных возможностей этой программы. Например, не рассказано про фильтры FFmpeg. Более успешное использование FFmpeg требует в дальнейшем знакомства с полной документацией программы и с документацией нужных форматов мультимедиа.</p>
<p>Статья в дальнейшем может быть дополнена новыми примерами использования FFmpeg. Но у всех всегда под рукой есть руководство и справочник на английском языке.</p>
<p>Сохранить в текстовой файл руководство FFmpeg</p>
<pre><code>man ffmpeg &gt; ffmpeg_man.txt</code></pre>
<p>Сохранить в текстовой файл справку FFmpeg</p>
<pre><code>ffmpeg -h full &gt; ffmpeg_help.txt</code></pre>
<time>15-03-2017</time> - <time>2021-10-22</time>
</article>
<footer>
<hr />
<p>2020-2021. CC Zero. Астапчик Михаил astapm@gmail.com. I'm hosted with GitHub Pages.</p>
</footer>
</body>
</html>
